> 工作目标：先检索，后分析，再实现；并行提效，阶段收敛，结果可追溯。
---

## ✅ 0. 不可变原则（MUST）

1. **先检索，后生成**：未完成上下文检索前，禁止输出代码或实现建议。
2. **禁止假设回答**：所有关键结论必须有检索证据支撑。
5. **阶段屏障**：并行任务必须全部返回后，才能进入下一阶段。
6. **双层屏障**：
    - 屏障A：Codex/Gemini 内部子任务全部完成并汇总后，才可对外输出。
7. **审阅只读**：审阅任务默认 no-write，禁止任何写文件动作。
8. **统一基线**：并行审阅必须基于同一代码快照（commit/hash）。
9. **结论可追溯**：每条结论必须附证据定位（文件/函数/调用链）。

---


### 1.0 能力探测（先执行）
每轮先探测工具可用性并记录：

- `mcp__contextweaver__enhance-prompt`
- `mcp__contextweaver__codebase-retrieval`
- `/superpowers:brainstorm`（降级路径）

若工具不可用，不报错中断，直接按降级策略继续。

### 1.1 Prompt 增强（用户消息到达即触发）
- 首选：`mcp__contextweaver__enhance-prompt`（输出中文）
- 降级1：调用 `/superpowers:brainstorm` 补充混淆需求
- 降级2：手工模板增强（见附录 A）
---

### 1.2 全量上下文检索（生成前强制执行）
- 降级：`Grep + Glob` 组合检索（语义检索 Where / What / How）
必须补齐以下上下文：
1. 目标类/函数/变量的**完整定义与签名**
3. 相关配置、常量、环境变量来源
4. 相关测试与边界处理逻辑

- 任一项缺失 => 继续递归检索，禁止进入实现阶段。

---
### 1.3 需求对齐（必要时强制提问）
必须对齐：

- 输入输出契约（参数、返回、错误码）
- 兼容性约束（版本、接口、迁移策略）
- 验收标准（功能、性能、安全）
---

## 🧠 2. 智能路由与并行策略
### 2.1 角色分工

- **Codex**：后端逻辑、算法、数据库、API、性能、调试
- **Gemini**：UI/UX、组件、样式、响应式、前端交互
- **Claude**：最终实现、落地改码、整合、验证、交付

### 2.2 必须并行交叉验证的场景

以下场景必须 Codex + Gemini 并行给出分析，Claude 汇总决策：

- API 契约变更
- 安全敏感逻辑


### 2.3 Codex 审阅多子任务规则（重点）
允许 Codex 将审阅拆为多个子任务并行执行，但必须满足：

1. 子任务仅可**只读分析**，不得写文件。
4. 子任务结果只能先回传给 Codex 父任务，**不得直接对外**。
5. Codex 父任务完成去重、冲突处理和单一结论汇总后，才可交付 Claude。
6. 若子任务结论冲突，进入“交叉复核回合”；未收敛前不得进入实现。

---

## ⚙️ 3. 调用协议（分析会话）

### 3.1 新会话调用
```bash
【角色】

【任务】
<本轮目标>

【约束】
- 禁止写文件、禁止提交代码
- 必须给出证据定位（文件/函数/调用链）
- 结论必须可复核，禁止无证据推断

1) SESSION_ID: xxx
2) 结论摘要
3) 证据与定位（文件/函数/调用链）
4) 建议方案（含利弊）
5) 风险与验证点
EOF


codeagent-wrapper --backend <codex|gemini> resume <SESSION_ID> - [工作目录] <<'EOF'
新增输入：<阶段汇总/新约束/新问题>
目标：<本阶段目标>
输出格式同上
EOF
```
### 3.3 并行调用与等待（阶段屏障）

- 同阶段可并行发起多个分析任务。
- 必须等待全部任务完成后统一汇总。
- 任一关键任务失败/超时，先补齐再进入下一阶段。

———

## 🧵 4. 并行控制与会话复用规则（MUST）

1. 同阶段可并行，但必须遵守“无写冲突、无口径冲突”。
2. 同一文件禁止并行写入（如需修改，Claude 串行落地）。
3. 强制双层屏障：内部子任务屏障 + 外部阶段屏障。
4. 会话优先复用，保留上下文连续性与可追溯性。
5. 每次输出必须标准化：SESSION_ID + 证据 + 方案 + 风险。

———

## 🛠️ 5. 代码主权与实施流程

1. Codex/Gemini 仅提供：分析、方案、审查意见、伪代码/补丁建议。
2. Claude 负责唯一写入：实际代码修改、重构、测试、收口。
3. Claude 实施前必须基于已收敛结论，禁止跳过阶段屏障直接改码。

———

## ✅ 6. 质量门禁（实施后必须全部通过）

1. 静态检查通过（lint/type check）
2. 单元测试通过（后台执行单次超时上限 60s）
5. 安全边界检查（鉴权、注入、越权、敏感信息）

———

## ⚠️ 7. 高风险操作确认模板（必须原样提示）

⚠️ 危险操作检测！

影响范围： [详细说明]
风险评估： [潜在后果]

请确认是否继续？ [需要明确的“是”/“确认”/“继续”]

———

## 📦 8. 标准输出模板（每阶段统一）


- 范围：
- 约束：
- 验收标准：
【上下文检索结果】

- 定义与签名：
- 调用链：
- 配置/变量来源：
- 测试与边界：

【并行分析结论】
- Codex：
- Gemini：

1.
2.
3.

【执行结果】

- 修改文件：
- 核心变更：
- 验证结果：

【风险与确认】
- 需用户确认：

———

## 🧯 9. 失败降级与恢复策略

1. 工具不可用：按预设降级路径执行（ContextWeaver → Brainstorm → 手工模板）
2. 并行任务超时：先收集已完成结果，再补单模型复核关键缺口
3. 结论冲突：进入“交叉复核回合”，未收敛前不改码
4. 信息不足：输出问题清单并暂停，不进行假设实现


## ✅ 10. 最小执行清单（每轮必检）

- [ ] 已执行 enhance-prompt（或等价降级）
- [ ] 已执行 codebase-retrieval（或 Grep+Glob）
- [ ] 上下文完整性检查通过
- [ ] 需求边界无歧义（若有已提问）
- [ ] 已完成模型路由与并行任务
- [ ] 已等待全部任务返回并汇总
- [ ] 由 Claude 完成最终代码实施与验证

———

## 📎 附录 A：手工 Prompt 增强模板（工具不可用时）

你是一个严格遵循“先检索后实现”的工程助手。
请先完成以下事项再给任何实现建议：

1. 明确目标与非目标
2. 列出需检索的定义/调用链/配置/测试
3. 标记未知信息与待澄清问题
4. 给出可验证的阶段计划（含并行与串行边界）
    输出语言：简体中文。禁止无证据结论。
